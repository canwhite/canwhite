# Claude Code 执行协议：全感知任务管理模式 v2.0

> [!CRITICAL]
> **⚠️ 核心原则：先文档
> **收到 START: 指令时，有两个必须操作**
> 1.必须先检查是否有production.md，如果有就去参考，如果没有没有就基于项目结构创建;
> 2.检查完production.md，必须创建 schema/task_*.md，然后才能执行任务**

---

## 核心行为准则
1. **先文档后执行** - 启动会话或开始新任务前，必须先同步 `production.md` 和 `schema/` 目录下的状态
2. **强制刷新** - 每一次回复的末尾必须包含【当前快照】
3. **文件驱动** - 所有进度必须落实到 `schema/task_*.md`

---

## 协议详细定义

### 0. 全局认知 (Global Awareness)
- **初始检查**: 启动时检查根目录是否存在 `production.md`。若无，必须执行 `ls -R` 并读取核心文件创建它。
- **内容要求**: [项目定位]、[核心架构]、[技术栈]、[目录结构说明]、[部署流程]。
- **动态维护**: 架构变更或模块新增时，同步更新此文件。

### 1. 任务启动 (Initialization)

#### 触发条件
收到以 `START: [任务描述]` 开头的指令。

#### ⭐⭐⭐ 强制执行流程 (CRITICAL)

**步骤1: 立即创建任务文档** (MANDATORY!)

```bash
# 必须立即执行！
date +"%y%m%d"  # 获取日期
```

使用 `Write` 工具创建 `schema/task_[简码]_[YYMMDD]_[HHMMSS].md`，内容必须包含：

```markdown
# Task: [任务描述]

**任务ID**: task_[简码]_[YYMMDD]_[HHMMSS]
**创建时间**: [当前日期]
**状态**: 进行中
**目标**: [一句话目标]

## 最终目标
[列出最终要达到的目标]

## 拆解步骤
### 1. [步骤1]
- [ ] 子任务1.1
- [ ] 子任务1.2

### 2. [步骤2]
- [ ] 子任务2.1
- [ ] 子任务2.2

## 当前进度
### 正在进行: [当前步骤]
[简要说明当前在做什么]

## 下一步行动
1. [具体下一步要做的原子动作]
2. [下一步...]
```

**步骤2: 创建TodoWrite列表** (RECOMMENDED)

```php
// 使用TodoWrite工具创建
[
    ["content": "步骤1", "status": "in_progress", "activeForm": "正在做步骤1"],
    ["content": "步骤2", "status": "pending", "activeForm": "等待做步骤2"]
]
```

**步骤3: 开始执行任务**

按照任务文档逐步执行，每完成一步更新任务文档。

#### 🚨 验证检查机制

在开始执行任务前，系统会自动检查：

```
检查清单:
□ schema/task_*_*.md 文件是否存在？
  └─ ❌ 如果不存在 → 立即停止，提示："错误：必须先创建任务文档"

□ 任务文档是否包含"最终目标"和"拆解步骤"？
  └─ ❌ 如果不完整 → 补充完整后再执行

□ TodoWrite列表是否已创建？
  └─ ⚠️ 可选，但强烈推荐
```

> [!WARNING]
> **禁止行为**:
> - ❌ 收到 `START:` 后直接使用 TodoWrite 而不创建任务文档
> - ❌ 收到 `START:` 后直接开始执行任务
> - ❌ 跳过任务文档创建步骤

> [!SUCCESS]
> **正确行为**:
> - ✅ 收到 `START:` → 立即创建 `schema/task_*.md`
> - ✅ 然后创建 TodoWrite（可选）
> - ✅ 最后开始执行任务

---

### 2. 动态上下文刷新 (Dynamic Refreshing)

- **执行规则**: 任务期间的**每一次回复**，必须执行：
  1. 完成实际的代码/命令操作
  2. ⭐⭐⭐ **强制检查任务文档**
     - 如果不存在 `schema/task_*.md` → **立即停止当前工作**
     - 创建任务文档并补充已完成的内容
     - 然后继续执行
  3. 更新 `schema/` 下的任务文档进度
  4. **末尾重述**：在回复末尾必须包裹以下代码块

```text
[项目全局状态]: 已同步至 production.md
[当前任务文件]: <schema/文件名>
[当前目标]: <一句话目标>
[已完成]: <最近一步操作>
[下一步]: <紧接着要执行的原子动作>
```

---

### 3. 任务结项 (Termination)

- **触发条件**: 收到 `DONE:`
- **动作**:
  1. 代码一致性检查
  2. 更新 `production.md` 反映新状态
  3. 归档：将任务文件移至 `schema/archive/`
  4. 确认关闭并停止回复末尾的重述

---

### 4. 记忆对齐 (Context Re-sync)

- 会话重启后，依次 `cat production.md` 和最新的 `schema/task_*.md`，对齐认知后再回复

---

### 5. 错误恢复机制 (Error Recovery)

#### 场景1: 忘记创建任务文档

**症状**: 收到 `START:` 指令，直接开始执行

**恢复步骤**:
1. **立即停止**当前工作
2. 创建 `schema/task_[简码]_[YYMMDD]_[HHMMSS].md`
3. 从对话历史提取已完成的工作内容
4. 补充到任务文档：
   - 最终目标
   - 已完成的步骤
   - 剩余步骤
5. 继续执行

**示例**:
```
❌ 错误行为:
用户: "START: 检查日志"
AI: 好的，让我开始检查...  ← 忘记创建文档

✅ 正确行为:
用户: "START: 检查日志"
AI: 收到指令，先创建任务文档...
    [Write schema/task_check_logs_260102.md]
    [TodoWrite ...]
    现在开始检查...
```

#### 场景2: 执行中才发现没有任务文档

**恢复步骤**:
1. 在下一次回复中立即创建
2. 从已完成的对话中提取信息
3. 补充完整任务文档
4. 继续执行

**示例**:
```markdown
// 执行中途发现错误
AI: （检查）发现没有任务文档，让我立即创建...
    [创建 schema/task_xxx.md]
    已补充前面的工作内容，继续...
```

---

### 6. TodoWrite 工具使用规范

#### ✅ 适合使用 TodoWrite 的场景

1. **已创建任务文档后** - 拆分子任务
2. **非START任务** - 如：
   - "检查这个文件"
   - "修复这个bug"
   - "优化这个函数"
3. **临时快速任务** - 不需要完整文档的任务

#### ❌ 禁止使用 TodoWrite 的场景

1. **收到 START: 指令时** - 必须先创建 `schema/task_*.md`
2. **任务文档创建之前** - 绝对禁止
3. **跳过文档创建** - 直接用TodoWrite代替

#### 正确流程对比

```
┌─────────────────────────────────────────┐
│ ❌ 错误流程 (FORBIDDEN)                  │
├─────────────────────────────────────────┤
│ 用户: "START: 检查日志"                  │
│    ↓                                    │
│ AI: TodoWrite [...] ← 错误！            │
│    ↓                                    │
│ 开始执行 ← 跳过了文档创建！              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ✅ 正确流程 (REQUIRED)                   │
├─────────────────────────────────────────┤
│ 用户: "START: 检查日志"                  │
│    ↓                                    │
│ AI: Write schema/task_xxx.md ← 先文档   │
│    ↓                                    │
│ AI: TodoWrite [...] ← 然后列表           │
│    ↓                                    │
│ 开始执行 ← 遵循协议！                    │
└─────────────────────────────────────────┘
```

#### 决策树

```
收到用户指令
    ↓
是 "START:" 开头吗?
    ├─ 是 →
    │   ├─ schema/task_*.md 是否存在?
    │   │   ├─ 否 → [必须] 先创建文档 → TodoWrite → 执行
    │   │   └─ 是 → TodoWrite → 执行
    │
    └─ 否 →
        ├─ 是否需要任务文档?
        │   ├─ 是 → 创建文档 → 执行
        │   └─ 否 → TodoWrite → 执行 (或直接执行)
```

---

## 核心原则总结

### 🎯 三大核心原则

1. **文档优先** (Documentation First)
   - START任务必须先创建文档
   - 文档驱动所有执行

2. **进度可追溯** (Traceable Progress)
   - 所有进度在 schema/task_*.md
   - 每一步都有记录

3. **上下文刷新** (Context Refresh)
   - 每次回复末尾重述
   - 检查文档是否存在

### ⚠️ 常见错误

| 错误 | 症状 | 后果 | 纠正 |
|------|------|------|------|
| **跳过文档创建** | 收到START直接执行 | 违反协议 | 立即创建文档 |
| **只用TodoWrite** | START后只用TodoWrite | 无文档记录 | 补创建文档 |
| **文档不完整** | 目标/步骤不清晰 | 难以追踪 | 补充完整 |
| **不更新进度** | 执行完不更新文档 | 进程丢失 | 及时更新 |

### ✅ 正确流程速查

```
START: [任务]
    ↓
[强制] Write schema/task_xxx.md
    ↓
[推荐] TodoWrite
    ↓
[执行] 按步骤执行
    ↓
[每次] 更新文档进度
    ↓
[末尾] 重述状态
    ↓
[完成] DONE → 归档
```

---

## 附录: 快速参考

### 任务文档模板

```markdown
# Task: [任务简述]

**任务ID**: task_[简码]_[YYMMDD]_[HHMMSS]
**创建时间**: YYYY-MM-DD
**状态**: 进行中

## 最终目标
[一句话目标]

## 拆解步骤
1. [步骤1]
   - [ ] 1.1
   - [ ] 1.2
2. [步骤2]
   - [ ] 2.1

## 当前进度
### 正在进行
[当前步骤描述]

## 下一步
1. [具体下一步]
```

### 末尾重述模板

```text
[项目全局状态]: 已同步至 production.md
[当前任务文件]: <文件名>
[当前目标]: <一句话目标>
[已完成]: <最近一步>
[下一步]: <下一步>
```

---

## 版本历史

- **v1.0** (2025-01-01): 初始版本
- **v2.0** (2026-01-02):
  - 新增：强制文档创建要求
  - 新增：错误恢复机制
  - 新增：TodoWrite使用规范
  - 新增：验证检查机制
  - 改进：流程对比示例

---

**协议维护**: 本协议是核心操作逻辑，旨在通过"物理文件记录"和"末尾重述机制"对抗长上下文带来的注意力衰减。

**核心信念**: 先文档，后执行，永远可追溯！
